<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>SPIFFS File Manager</title>
    <style>
        body {
            overflow-y: scroll;
            font-family: Arial, sans-serif;
            margin: 0;
            background-color: #121212;
            color: #E0E0E0;
        }
    
        h1 {
            color: #FFFFFF;
            text-align: center;
            margin-bottom: 20px;
            font-size: 2rem;
            background: linear-gradient(90deg, #FF00FF, #8800FF);
            -webkit-background-clip: text;
            color: transparent;
        }
    
        .info {
            text-align: center;
            margin: 20px auto;
            font-size: 18px;
        }
    
        table {
            width: 80%;
            margin: 20px auto;
            border-collapse: separate; /* Erm√∂glicht abgerundete Ecken */
            border-spacing: 0; /* Entfernt Abst√§nde zwischen Zellen */
            border: 2px solid #FF00FF; /* Magenta-Rahmen */
            border-radius: 15px; /* Abgerundete Ecken */
            background-color: #1E1E1E; /* Hintergrundfarbe */
            overflow: hidden; /* Sorgt daf√ºr, dass abgerundete Ecken auch f√ºr Zellen-Inhalt gelten */
            box-shadow: 0 4px 15px rgba(255, 0, 255, 0.3); /* Leichter Gl√ºheffekt */
            transition: all 0.3s ease;
        }
    
        thead {
            background: linear-gradient(90deg, #FF00FF, #8800FF); /* Durchg√§ngiger Farbverlauf f√ºr Kopfzeile */
        }
    
        th {
            color: #FFFFFF; /* Helle Schriftfarbe */
            font-weight: bold;
            padding: 10px;
            text-align: left;
            text-shadow: -1px -1px 0 #000, 1px -1px 0 #000, -1px 1px 0 #000, 1px 1px 0 #000; /* Schwarze Outline */
            border-right: 1px solid rgba(255, 255, 255, 0.2); /* Subtiler Spaltentrenner */
        }
    
        th:last-child {
            border-right: none; /* Kein Spaltentrenner f√ºr die letzte Spalte */
        }
    
        td {
            padding: 10px;
            text-align: left;
            border-right: 1px solid #FF00FF; /* Magenta Spaltentrenner */
            border-bottom: 1px solid #FF00FF; /* Magenta Zeilentrenner */
            white-space: nowrap; /* Verhindert Umbruch */
            color: #FFFFFF;
        }
    
        td:last-child {
            border-right: none; /* Kein Spaltentrenner f√ºr die letzte Spalte */
        }
    
        tr:nth-child(even) {
            background-color: #2A2A2A; /* Subtile Hervorhebung f√ºr gerade Zeilen */
        }

        tr:last-child td {
            border-bottom: none; /* Entfernt die untere Linie in der letzten Zeile */
        }
    
        tr:hover td {
            background: linear-gradient(90deg, #3A3A3A, #505050); /* Farbverlauf beim Hover */
            transition: all 0.3s ease;
        }
    
        button {
            padding: 5px 15px;
            border: none;
            color: white;
            font-size: 16px;
            cursor: pointer;
            /*border-radius: 10px;*/
            transition: all 0.3s ease;
            font-weight: bold;
            text-shadow: -1px -1px 0 #000, 1px -1px 0 #000, -1px 1px 0 #000, 1px 1px 0 #000; /* Schwarze Outline */
        }

        /* Download-Button */
        .download-button {
            background: linear-gradient(90deg, #3399FF, #0066CC); /* Sanftes Blau */
            box-shadow: 0 4px 10px rgba(51, 153, 255, 0.4); /* Blauer Gl√ºheffekt */
        }

        .download-button:hover {
            background: linear-gradient(90deg, #0066CC, #3399FF); /* Umgekehrter Verlauf */
            box-shadow: 0 4px 15px rgba(51, 153, 255, 0.6); /* Verst√§rkter Gl√ºheffekt */
        }

        /* L√∂schen-Button */
        .delete-button {
            background: linear-gradient(90deg, #FF4500, #FF0000); /* Intensiveres Rot */
            box-shadow: 0 4px 10px rgba(255, 69, 0, 0.4); /* Gl√ºheffekt Rot */
        }

        .delete-button:hover {
            background: linear-gradient(90deg, #FF0000, #FF4500); /* Umgekehrter Verlauf */
            box-shadow: 0 4px 15px rgba(255, 69, 0, 0.6); /* Verst√§rkter Gl√ºheffekt */
        }

        /* Edit-Button */
        .edit-button {
            background: linear-gradient(90deg, #FFAA00, #FF6600); /* Orange f√ºr Edit */
            box-shadow: 0 4px 10px rgba(255, 170, 0, 0.4); /* Gl√ºheffekt Orange */
        }

        .edit-button:hover {
            background: linear-gradient(90deg, #FF6600, #FFAA00); /* Umgekehrter Verlauf */
            box-shadow: 0 4px 15px rgba(255, 170, 0, 0.6); /* Verst√§rkter Gl√ºheffekt */
        }
    
        .table-container {
            width: 80%; /* Gleiche Breite wie die Tabelle */
            margin: 20px auto;
        }
    
        .progress-container {
            width: calc(100% - 20px); /* Gleiche Breite wie die Tabelle */
            max-width: 80%; /* Beschr√§nkung auf 80% */
            margin: 0 auto;
            background-color: #2A2A2A;
            border-radius: 10px;
            box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.2);
            height: 25px;
            overflow: hidden;
            margin-bottom: 10px;
        }
    
        .progress-bar {
            height: 100%;
            background: linear-gradient(90deg, #FF00FF, #8800FF); /* Magenta Farbverlauf */
            width: 0%; /* Dynamische Breite in JS aktualisieren */
            text-align: center;
            line-height: 25px;
            color: white;
            font-weight: bold;
            transition: width 0.5s ease-in-out;
        }
    
        .success-message {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: linear-gradient(90deg, #4CAF50, #2E7D32); /* Gr√ºner Farbverlauf */
            color: white;
            padding: 10px 20px;
            border-radius: 15px; /* St√§rkere Rundungen */
            box-shadow: 0 4px 15px rgba(0, 255, 0, 0.3); /* Gl√ºheffekt in Gr√ºn */
            display: none;
            z-index: 1000;
            animation: fadeInOut 10s ease-in-out forwards;
            font-weight: bold; /* Text betonen */
            text-align: center; /* Zentrierter Text */
        }
    
        @keyframes fadeInOut {
            0% { opacity: 0; }
            10% { opacity: 1; }
            90% { opacity: 1; }
            100% { opacity: 0; }
        }
        /* Webkit-basiertes Styling f√ºr Scrollbars */
        ::-webkit-scrollbar {
            width: 10px; /* Breite der Scrollbar */
        }

        ::-webkit-scrollbar-track {
            background: #1E1E1E; /* Hintergrund der Scrollbar-Leiste */
            border-radius: 10px; /* Abgerundete Ecken */
        }

        ::-webkit-scrollbar-thumb {
            background: linear-gradient(90deg, #FF00FF, #8800FF); /* Farbverlauf f√ºr die Scrollbar */
            border-radius: 10px; /* Abgerundete Ecken */
            box-shadow: inset 0 0 5px rgba(0, 0, 0, 0.5); /* Subtiler Schatten f√ºr mehr Tiefe */
        }

        ::-webkit-scrollbar-thumb:hover {
            background: linear-gradient(90deg, #8800FF, #FF00FF); /* Umgekehrter Farbverlauf beim Hover */
        }
    </style>
    
</head>
<body>
    <div id="menu-placeholder"></div>
    <h1>SPIFFS File Manager</h1>
    <div id="success-message" class="success-message">
        Datei erfolgreich gespeichert!
    </div>
    <div id="storage-info" class="table-container"></div>
    <div class="table-container">
        <div class="progress-container">
           <div id="progress-bar" class="progress-bar">0%</div>
        </div>
        <table>
            <thead>
                <tr>
                    <th>Dateiname</th>
                    <th>Gr√∂√üe (Bytes)</th>
                    <th>Aktionen</th>
                </tr>
            </thead>
            <tbody id="file-list"></tbody>
        </table>
    </div>
    <script>
        // Men√º laden
        fetch('menu.html')
        .then(response => response.text())
        .then(data => {
            document.getElementById('menu-placeholder').innerHTML = data;
            
            const currentPath = window.location.pathname; 
            // z.B. /files.html (egal, ob ?saved=true anh√§ngt)

            document.querySelectorAll('.menu a').forEach(link => {
                // Wir holen den Pfad aus dem Link (nur /irgendwas.html ohne Query)
                const linkPath = new URL(link.href).pathname; 
                
                if (linkPath === currentPath) {
                    link.classList.add('active');
                }
            });
        })
        .catch(error => console.error('Fehler beim Laden des Men√ºs:', error));

        // Neue Funktion zum Erstellen der Datei/Ordner-Zeile
        function createTableRow(item, currentPath = '') {
            const row = document.createElement('tr');
            const isDirectory = item.type === 'dir';
            const fullPath = currentPath + item.name;
            
            row.innerHTML = `
                <td>
                    ${isDirectory ? 
                        `<span style="cursor: pointer" onclick="toggleFolder('${fullPath}')">
                            üìÅ ${item.name}
                        </span>` : 
                        `üìÑ ${item.name}`}
                </td>
                <td>${isDirectory ? '-' : item.size + ' Bytes'}</td>
                <td>
                    ${isDirectory ? 
                        '' : 
                        `<button class="download-button" onclick="location.href='/download?name=${fullPath}'">Download</button>
                         <button class="delete-button" onclick="deleteFile('${fullPath}')">L√∂schen</button>
                         <button class="edit-button" onclick="editFile('${fullPath}')">Edit</button>`
                    }
                </td>
            `;
            return row;
        }

        // Modifizierte fetchFileList Funktion
        async function fetchFileList(path = '') {
            try {
                console.log('Fetching files for path:', path);
                const response = await fetch(`/api/files?path=${encodeURIComponent(path)}`);
                const items = await response.json();
                console.log('Received items:', items);
                
                const fileList = document.getElementById('file-list');
                
                // Sortiere Eintr√§ge: Ordner zuerst, dann Dateien
                const sortedItems = items.sort((a, b) => {
                    if (a.type === b.type) return a.name.localeCompare(b.name);
                    return a.type === 'dir' ? -1 : 1;
                });

                fileList.innerHTML = '';
                
                // Wenn wir im Root-Verzeichnis sind, zeige beide Dateisysteme an
                if (!path) {
                    // SPIFFS Ordner
                    const spiffsRow = document.createElement('tr');
                    spiffsRow.innerHTML = `
                        <td>
                            <span style="cursor: pointer" onclick="toggleFolder('SPIFFS:')">
                                üìÅ SPIFFS:
                            </span>
                        </td>
                        <td>-</td>
                        <td></td>
                    `;
                    fileList.appendChild(spiffsRow);
                    
                    // Container f√ºr SPIFFS Inhalt
                    const spiffsContainer = document.createElement('tr');
                    spiffsContainer.id = 'folder-SPIFFS:';
                    spiffsContainer.style.display = 'none';
                    spiffsContainer.innerHTML = `
                        <td colspan="3" style="padding-left: 30px">
                            <div id="content-SPIFFS:"></div>
                        </td>
                    `;
                    fileList.appendChild(spiffsContainer);

                    // SD Ordner
                    const sdRow = document.createElement('tr');
                    sdRow.innerHTML = `
                        <td>
                            <span style="cursor: pointer" onclick="toggleFolder('SD:')">
                                üìÅ SD:
                            </span>
                        </td>
                        <td>-</td>
                        <td></td>
                    `;
                    fileList.appendChild(sdRow);
                    
                    // Container f√ºr SD Inhalt
                    const sdContainer = document.createElement('tr');
                    sdContainer.id = 'folder-SD:';
                    sdContainer.style.display = 'none';
                    sdContainer.innerHTML = `
                        <td colspan="3" style="padding-left: 30px">
                            <div id="content-SD:"></div>
                        </td>
                    `;
                    fileList.appendChild(sdContainer);
                } else {
                    // Normaler Ordnerinhalt anzeigen
                    sortedItems.forEach(item => {
                        const prefix = path.startsWith('SD:') ? 'SD:' : 'SPIFFS:';
                        const fullPath = path ? `${path}/${item.name}`.replace(/\/+/g, '/') : `${prefix}${item.name}`;
                        
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td style="padding-left: 20px">
                                ${item.type === 'dir' ? 
                                    `<span style="cursor: pointer" onclick="toggleFolder('${fullPath}')">
                                        üìÅ ${item.name}
                                    </span>` : 
                                    `üìÑ ${item.name}`}
                            </td>
                            <td>${item.type === 'dir' ? '-' : item.size + ' Bytes'}</td>
                            <td>
                                ${item.type === 'dir' ? '' : 
                                `<button class="download-button" onclick="location.href='/download?name=${fullPath}'">Download</button>
                                 <button class="delete-button" onclick="deleteFile('${fullPath}')">L√∂schen</button>
                                 <button class="edit-button" onclick="editFile('${fullPath}')">Edit</button>`}
                            </td>
                        `;
                        fileList.appendChild(row);
                        
                        if (item.type === 'dir') {
                            const subContainer = document.createElement('tr');
                            subContainer.id = `folder-${fullPath}`;
                            subContainer.style.display = 'none';
                            subContainer.innerHTML = `
                                <td colspan="3" style="padding-left: 40px">
                                    <div id="content-${fullPath}"></div>
                                </td>
                            `;
                            fileList.appendChild(subContainer);
                        }
                    });
                }
            } catch (error) {
                console.error('Error fetching file list:', error);
                document.getElementById('file-list').innerHTML = `
                    <tr>
                        <td colspan="3">Fehler beim Laden der Dateiliste: ${error.message}</td>
                    </tr>
                `;
            }
        }

        // Modifizierte toggleFolder Funktion
        async function toggleFolder(path) {
            const folderId = `folder-${path}`;
            const folderElement = document.getElementById(folderId);
            const contentId = `content-${path}`;
            
            if (folderElement.style.display === 'none') {
                folderElement.style.display = 'table-row';
                try {
                    console.log('Requesting path:', path);
                    const response = await fetch(`/api/files?path=${encodeURIComponent(path)}`);
                    const items = await response.json();
                    console.log('Received items:', items);
                    
                    if (!Array.isArray(items) || items.length === 0) {
                        const contentElement = document.getElementById(contentId);
                        contentElement.innerHTML = `
                            <table style="width: 100%; margin: 0;">
                                <tbody>
                                    <tr>
                                        <td colspan="3">Ordner ist leer</td>
                                    </tr>
                                </tbody>
                            </table>
                        `;
                        return;
                    }

                    const prefix = path.startsWith('SD:') ? 'SD:' : 'SPIFFS:';
                    const contentElement = document.getElementById(contentId);
                    contentElement.innerHTML = `
                        <table style="width: 100%; margin: 0;">
                            <tbody>
                                ${items.map(item => {
                                    const fullPath = `${path}/${item.name}`.replace(/\/+/g, '/');
                                    return `<tr>
                                        <td style="padding-left: 20px">
                                            ${item.type === 'dir' ? 
                                                `<span style="cursor: pointer" onclick="toggleFolder('${fullPath}')">
                                                    üìÅ ${item.name}
                                                </span>` : 
                                                `üìÑ ${item.name}`}
                                        </td>
                                        <td>${item.type === 'dir' ? '-' : item.size + ' Bytes'}</td>
                                        <td>
                                            ${item.type === 'dir' ? '' : 
                                            `<button class="download-button" onclick="location.href='/download?name=${fullPath}'">Download</button>
                                             <button class="delete-button" onclick="deleteFile('${fullPath}')">L√∂schen</button>
                                             <button class="edit-button" onclick="editFile('${fullPath}')">Edit</button>`}
                                        </td>
                                    </tr>
                                    ${item.type === 'dir' ? `
                                    <tr id="folder-${fullPath}" style="display: none;">
                                        <td colspan="3" style="padding-left: 40px">
                                            <div id="content-${fullPath}"></div>
                                        </td>
                                    </tr>` : ''}`
                                }).join('')}
                            </tbody>
                        </table>
                    `;
                } catch (error) {
                    console.error('Error fetching folder contents:', error);
                    const contentElement = document.getElementById(contentId);
                    contentElement.innerHTML = `
                        <table style="width: 100%; margin: 0;">
                            <tbody>
                                <tr>
                                    <td colspan="3">Fehler beim Laden des Ordnerinhalts: ${error.message}</td>
                                </tr>
                            </tbody>
                        </table>
                    `;
                }
            } else {
                folderElement.style.display = 'none';
            }
        }

        async function fetchStorageInfo() {
            const response = await fetch('/api/storage');
            const info = await response.json();
            const storageInfo = document.getElementById('storage-info');

            // Helper-Funktion zum Umrechnen von Bytes in MB
            function bytesToMB(bytes) {
                return (bytes / (1024 * 1024)).toFixed(2); // 2 Dezimalstellen
            }

            storageInfo.innerHTML = `
                <table>
                    <thead>
                        <tr>
                            <th>Speicher</th>
                            <th>Gesamtspeicher (MB)</th>
                            <th>Genutzter Speicher (MB)</th>
                            <th>Freier Speicher (MB)</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>SPIFFS</td>
                            <td>${bytesToMB(info.SPIFFS.total)} MB</td>
                            <td>${bytesToMB(info.SPIFFS.used)} MB</td>
                            <td>${bytesToMB(info.SPIFFS.free)} MB</td>
                        </tr>
                        <tr>
                            <td>SD</td>
                            <td>${info.SD.total ? bytesToMB(info.SD.total) + " MB" : "N/A"}</td>
                            <td>${info.SD.used ? bytesToMB(info.SD.used) + " MB" : "N/A"}</td>
                            <td>${info.SD.free ? bytesToMB(info.SD.free) + " MB" : "N/A"}</td>
                        </tr>
                    </tbody>
                </table>
            `;

            // Fortschrittsbalken f√ºr SPIFFS aktualisieren
            const progressBar = document.getElementById('progress-bar');
            const usedPercentage = ((info.SPIFFS.used / info.SPIFFS.total) * 100).toFixed(1);
            progressBar.style.width = `${usedPercentage}%`;
            progressBar.textContent = `${usedPercentage}%`;
        }

        async function deleteFile(fileName) {
            if (confirm(`M√∂chten Sie die Datei '${fileName}' wirklich l√∂schen?`)) {
                const response = await fetch(`/delete?name=${fileName}`, { method: 'DELETE' });
                if (response.ok) {
                    alert('Datei erfolgreich gel√∂scht!');
                    fetchFileList(); // Liste aktualisieren
                } else {
                    alert('Fehler beim L√∂schen der Datei!');
                }
            }
        }

        function checkSaved() {
            const params = new URLSearchParams(window.location.search);
            if (params.get('saved') === 'true') {
                const successMessage = document.getElementById('success-message');
                successMessage.innerText = "Datei erfolgreich gespeichert!";
                successMessage.style.display = 'block';
                setTimeout(() => {
                    successMessage.style.display = 'none';
                }, 10000); // Nach 10 Sekunden ausblenden
            }
        }

        function checkUploaded() {
            const params = new URLSearchParams(window.location.search);
            if (params.get('uploaded') === 'true') {
                // Erfolgsmeldung zeigen
                const successMessage = document.getElementById('success-message');
                successMessage.innerText = "Datei erfolgreich hochgeladen!";
                successMessage.style.display = 'block';
                setTimeout(() => {
                    successMessage.style.display = 'none';
                }, 10000); // z.B. nach 10 Sek. ausblenden
            }
        }

        // Neue Hilfsfunktion zum Laden der Datei
        async function loadFileContent(fullPath) {
            try {
                console.log('Loading file content for:', fullPath);
                const response = await fetch(`/api/content?name=${encodeURIComponent(fullPath)}`);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const content = await response.text();
                console.log('Content loaded, length:', content.length);
                return content;
            } catch (error) {
                console.error('Error loading file:', error);
                alert('Fehler beim Laden der Datei: ' + error.message);
                return null;
            }
        }

        // Modifizierte Edit-Button-Funktion
        async function editFile(fullPath) {
            const content = await loadFileContent(fullPath);
            if (content !== null) {
                location.href = `/edit?name=${encodeURIComponent(fullPath)}`;
            }
        }

        fetchFileList();
        fetchStorageInfo();
        checkUploaded();
        checkSaved();
    </script>
</body>
</html>
